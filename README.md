# Fact Check システム - OpenAI & Wikidata API統合版

## 概要

このシステムは、**実際のOpenAI APIとWikidata API**を使用した本格的なファクトチェックシステムです。高橋萌香さんの卒業研究「Wikidataを用いた大規模言語モデルのFact Checkシステムの開発」のUIデザインを参考に、拡張性と実用性を重視して開発されました。

## 🔧 **最新更新: 動的属性選択システム実装完了 (2024-09-16)**

### ✨ **動的属性選択システムの全面実装**
従来の固定カテゴリベース属性選択を廃止し、選択されたエンティティから実際に利用可能な属性を動的に取得するインテリジェントシステムを実装：

1. **リアルタイム属性分析**: 選択されたエンティティのWikidataクレームを即座に分析
2. **実データベース属性選択**: 実際にデータが存在する属性のみを表示（✓マーク付き）
3. **未知プロパティ対応**: マッピングに存在しない属性も日本語ラベルを取得して表示
4. **プロパティID表示**: 各属性にWikidataプロパティIDをツールチップ表示
5. **適応型UI**: エンティティタイプに完全適応した属性選択肢を自動生成

**技術的実装**:
- `updateAttributeOptions()`: 非同期でエンティティの実際の利用可能プロパティを取得
- `getAvailableAttributesFromEntity()`: エンティティのクレームを分析し実際のデータがあるプロパティを抽出  
- `resolvePropertyLabel()`: 未知プロパティの日本語ラベル取得
- `getPropertyMapping()`: 包括的なプロパティIDマッピング（50+ 属性対応）

**解決された具体例**:
- **Before**: スズキ（自動車メーカー）で「教員数」など無関係な属性が表示
- **After**: 実際に存在する「設立年」「本社所在地」「業界」「ウェブサイト」のみ表示
- **Before**: 不明な属性は英語ID（P571など）で表示  
- **After**: 全て日本語ラベル（「設立年」「本社所在地」など）で表示

## 🔧 **前回更新: Wikidata位置情報取得の階層化対応 (2024-09-15)**

### ✨ **位置情報データ取得の根本的改善**
Wikidataからの位置情報取得を階層的に改良し、GPTとの統一フォーマットを実現：

1. **階層的位置情報取得**: P131を再帰的に辿って都道府県,市区町村形式で取得
2. **カンマ区切り統一**: Wikidata・LLM両方で「,」区切りに統一（「、」廃止）
3. **GPTプロンプト改良**: 「都道府県,市区町村」形式を明示的に指示
4. **東大ケース対応**: 「本郷」→「東京都,文京区」のような詳細地名から行政区分への変換

**解決された具体例**:
- **東大ケース**: Wikidata「本郷」→「東京都,文京区」/ GPT「東京都,文京区」→ 一致
- **マツダケース**: Wikidata「広島県,府中町」/ GPT「広島県,安芸郡府中町」→ 包含一致 (85%)

### 🔧 **町村レベル包含関係の強化対応 (2024-09-15 追加修正)**
マツダ本社所在地ケースに対応した包含関係判定の強化：

1. **町村特別処理**: 「府中町」⊂「安芸郡府中町」の包含関係を正確に判定
2. **詳細ログ出力**: 判定プロセスの可視化で問題箇所の特定を容易化
3. **段階的判定**: 完全一致→町村包含→市区包含→部分一致の多段階チェック
4. **実用性重視**: 地理的に同一の場所を異なる詳細度で表現した場合の適切な一致判定

### 🔧 **UI改善: API確認ダイアログ重複修正 (2024-09-15)**

**修正された問題**: 
- **Before**: API実行時に確認ダイアログが2回表示される
- **After**: 確認ダイアログが1回のみ表示される

**技術的修正**:
1. **重複イベントリスナー削除**: `execute-btn`の重複登録を解消
2. **addEventListenerSafe強化**: データ属性による重複防止機能を追加
3. **デバッグログ追加**: イベントリスナー登録状況の可視化

### 🎯 **動的エンティティタイプ別属性プリセット (2024-09-15)**

**新機能**: エンティティの種類に応じた適切な属性候補の自動選択システム

**改善内容**:
1. **細分化されたエンティティタイプ対応**: 
   - 自動車メーカー (Q786820) → 設立年、本社、業界、売上など
   - テクノロジー企業 (Q1137109) → 設立年、本社、従業員数など  
   - 製造業 (Q319913) → 業界特有の属性
   
2. **優先度ベース属性選択**: より具体的なエンティティタイプを優先
3. **不適切属性の除外**: 企業に対して「教員数」などの不適切な属性を非表示
4. **デバッグログ**: エンティティタイプ分析と属性選択プロセスを可視化

**解決された問題**:
- **Before**: スズキ（自動車メーカー）で「教員数」が表示
- **After**: 自動車メーカーに適した「設立年、本社、業界」等のみ表示

### ✨ **位置情報判定の精度向上 (前回更新)**
日本の行政区分階層（郡レベル）に対応した高精度な位置情報比較システムを実装：

1. **郡レベル対応**: 「広島県、安芸郡府中町」形式の処理
2. **階層的包含関係**: 「府中町」⊂「広島県、安芸郡府中町」の正確な判定  
3. **カンマ区切り改良**: 高橋さんの研究手法に基づく詳細な行政区分解析
4. **包含アルゴリズム強化**: より精密な階層構造の認識と比較

## 🔧 **モジュラーリファクタリング完了 (2024-09-15)**

### ✨ **新しいモジュラーアーキテクチャ**
コードベースを完全にリファクタリングし、保守性と拡張性を大幅に向上させました：

1. **js/config.js** - 全設定とコンフィギュレーション集約
2. **js/fact-check-system.js** - 基盤クラスと初期化処理  
3. **js/wikidata-api.js** - Wikidata専用APIモジュール
4. **js/openai-api.js** - OpenAI専用APIモジュール
5. **js/main-refactored.js** - メインアプリケーションエントリーポイント

### 🎯 **リファクタリングの成果**
- **コード重複の削除**: 設定を一箇所に集約
- **関心の分離**: 各APIが独立したモジュールに
- **保守性向上**: 明確な責任分担とクリーンなインターフェース
- **エラー削除**: 全ての警告とエラーを解消
- **機能保持**: 既存の全機能を完全に維持

## 🚀 **主要機能**

### 🆕 **一括検索機能 (2024-09-14)**
### 🔧 **高橋さんの研究手法完全実装 (2024-09-15)**
1. **SPARQLクエリベース一括検索**
   - 高橋萌香さんの研究手法を完全再現
   - 7つのカテゴリ対応（日本の大学、都道府県、山、河川、企業、世界の国、首都）
   - 自動的に複数エンティティの情報を一括取得

2. **一括ファクトチェック機能**
   - 複数エンティティ×複数属性の自動検証
   - リアルタイムプログレス表示
   - API使用量の自動管理

3. **データ可視化・エクスポート**
   - Chart.jsによる統計グラフ表示
   - CSV/JSON形式でのデータ出力
   - 詳細な検証結果テーブル

4. **高橋さんの研究手法完全準拠**
   - **カンマ区切り統一フォーマット**: Wikidata・LLM両方でカンマ区切り形式
   - **一括属性取得**: 複数属性を1回のAPI呼び出しで効率的に取得
   - **エンティティタイプ最適化**: 山・大学などの既知タイプを直接マッピング
   - **改良SPARQLクエリ**: 選択属性に基づく動的クエリ生成

### 🔧 **最新修正 (2025-08-31)**
1. **Critical JavaScript Fixes**
   - 初期化処理の修正: `init()`メソッドの呼び出し不足を解決
   - 正規表現構文エラーの修正: 不正なスラッシュエスケープを修正
   - 文字列エスケープ修正: CSVエクスポートの改行文字エラーを解決

2. **機能復旧完了**
   - ✅ APIキー接続テスト機能
   - ✅ エンティティ検索機能
   - ✅ プロンプトパターン選択機能
   - ✅ ボタン表示の正常化

3. **🔬 高度なURL評価システム (2025-08-31)**
   - **インテリジェントURL抽出**: 文章中からURLを自動抽出
   - **多段階評価**: 完全一致 → URL抽出 → ドメイン解析 → 意味的類似性
   - **学術研究ベース**: ファクトチェック研究の知見を活用
   - **高精度判定**: 文章中のURL情報も正確に評価

4. **🏷️ インテリジェントラベル解決システム (2025-08-31)**
   - **WikidataID→ラベル変換**: Q335080 → 新海誠 のような自動変換
   - **高度な人物名抽出**: 文章中から人物名を正確に抽出
   - **柔軟な名前マッチング**: 読み方違い・表記揺れに対応
   - **類似性判定**: レーベンシュタイン距離による高精度判定

### ✅ **実API統合**
1. **OpenAI API完全対応**
   - **GPT-3.5 Turbo, GPT-4o Mini, GPT-4o, GPT-4, GPT-5** 対応
   - **モデル選択UI**: ドロップダウンで簡単切り替え
   - **リアルタイムコスト表示**: モデル別料金を即座に表示
   - トークン使用量監視とコスト計算

2. **Wikidata API検索**
   - リアルタイムエンティティ検索
   - 自動属性抽出
   - 無制限のデータアクセス
   - **SPARQLクエリ対応**: 高橋萌香さんの研究手法を完全実装

3. **一括検索・検証システム (NEW!)**
   - **7つの検索カテゴリ**: 日本の大学、都道府県、山、河川、企業、世界の国・首都
   - **SPARQLベース**: WikidataのSPARQLエンドポイントを直接活用
   - **複数属性同時検証**: カテゴリごとに最適化された属性セット
   - **リアルタイムプログレス**: 検索・検証の進行状況をリアルタイム表示
   - **統計可視化**: Chart.jsによる検証結果の自動グラフ生成
   - **データエクスポート**: CSV/JSON形式での結果出力

3. **使用量制限・監視システム**
   - 1日/1時間あたりの使用上限設定
   - リアルタイムコスト追跡
   - 実行前確認ダイアログ

### ✅ **大幅なUX改善**
1. **動的エンティティ検索**
   - 固定選択肢から無制限検索に変更
   - 日本語・英語対応
   - リアルタイム候補表示

2. **慎重な設計**
   - API実行前の確認機能
   - 詳細なコスト表示
   - エラーハンドリング強化

## 🔧 **システム仕様**

### API統合仕様

#### OpenAI API
- **対応モデル**: 
  - `gpt-4o-mini` ($0.0002/1K tokens) - **推奨**
  - `gpt-3.5-turbo` ($0.002/1K tokens)
  - `gpt-4` ($0.03/1K tokens)
- **最大トークン**: 150 (回答制限)
- **Temperature**: 0.1 (精度重視)

#### Wikidata API
- **Entity Search API**: エンティティ検索
- **Entity Details API**: 属性詳細取得
- **対応言語**: 日本語・英語
- **制限**: なし（無料API）

### 使用量制限システム

#### デフォルト制限
- **1日あたり**: 20回
- **1時間あたり**: 10回
- **設定変更**: 可能（1-100回）

#### コスト監視
- **リアルタイム計算**: トークン使用量 × モデル料金
- **累積表示**: セッション通算コスト
- **警告機能**: 上限80%で色変更

## 🎯 **使用方法**

### 初期設定

1. **APIキー設定**
   ```
   1. OpenAI APIキーを取得（https://platform.openai.com/）
   2. 「API設定・使用量監視」セクションでキー入力
   3. 「接続テスト」ボタンで動作確認
   4. ✓ 接続成功の表示を確認
   ```

2. **使用制限設定**
   ```
   - 1日あたりの使用上限: 20回（推奨）
   - 1時間あたりの使用上限: 10回（推奨）
   - API実行前に確認: チェック推奨
   ```

### ファクトチェック実行

1. **エンティティ検索**
   - 検索ボックスに名前を入力（例：「東京大学」「富士山」「トヨタ」）
   - 候補から適切なエンティティを選択
   - Wikidata IDと説明を確認

2. **属性選択**
   - 自動抽出された属性から選択
   - 例：設立年、都道府県、標高、全長など

3. **プロンプトパターン選択**
   - 5種類から研究目的に応じて選択
   - 直接型、丁寧型、正確性強調型、信頼性重視型、詳細型

4. **実行・確認**
   - 「実行」ボタンクリック
   - コスト・使用回数確認ダイアログ
   - OK後にOpenAI APIを実行

5. **結果確認**
   - ChatGPT回答の詳細表示
   - Wikidataとの一致確認（○△×）
   - 信頼度スコア・統計表示

## 🔄 **動的一括検索モードの使用方法 (NEW!)**

### 🎯 **従来の固定カテゴリの問題を解決**
- **問題**: 事前決定されたカテゴリでは検索の意味が薄い
- **解決**: ユーザーが自由にエンティティタイプと条件を指定可能

### 📋 **使用手順**

1. **モード切り替え**
   - ページ上部の「一括検索モード（SPARQL）」を選択

2. **エンティティタイプ検索** 🔍
   - 「エンティティタイプを検索」欄に興味のあるタイプを入力
   - 例：「大学」「山」「企業」「人物」「映画」など
   - Wikidataから該当するエンティティタイプを動的検索
   - 検索結果から適切なタイプを選択

3. **検索条件設定** ⚙️
   - **地域フィルタ**: 日本のみ、アメリカのみなど（任意）
   - **追加条件**: 自然言語で条件を入力（例：「設立年が1900年以降」）
   - **取得件数**: 1-50件（初回は少数推奨）

4. **SPARQLプレビュー** 👀
   - 生成されるSPARQLクエリをリアルタイムプレビュー
   - 検索対象・条件・件数を事前確認

5. **検証属性選択** ✅
   - 検証したい属性を複数選択
   - 一般的属性：設立年、所在地、面積、標高、ウェブサイトなど

6. **実行・結果確認** 🚀
   - 動的SPARQLクエリでWikidataから実際にデータを取得
   - 各エンティティに対してOpenAI APIでファクトチェック実行
   - リアルタイムプログレス表示

7. **結果分析・エクスポート** 📊
   - 詳細テーブルで全結果確認
   - 統計グラフで一致率を可視化
   - CSV/JSON形式でデータエクスポート

### 💡 **利点**
- **真の検索価値**: 固定カテゴリではなく、ユーザーの関心に基づく動的検索
- **柔軟性**: 任意のエンティティタイプと条件を組み合わせ可能
- **透明性**: SPARQLクエリを事前プレビューで内容確認
- **実用性**: 実際のWikidataから最新データを取得してファクトチェック

## 📊 **実装されたAPI連携**

### Wikidata検索例
```javascript
// エンティティ検索
const searchUrl = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${query}&language=ja&format=json&origin=*&limit=10`;

// 属性詳細取得
const detailsUrl = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${entityId}&languages=ja|en&format=json&origin=*`;
```

### OpenAI API呼び出し例
```javascript
const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 150,
        temperature: 0.1
    })
});
```

## ⚡ **推奨される使用方針**

### コスト効率化
1. **GPT-4o Mini使用**: 最もコスト効率が良い（GPT-4の1/150）
2. **制限設定**: 1日20回、1時間10回で開始
3. **確認機能**: 必ず有効にして誤操作を防止

### 研究活用
1. **小規模実験**: 各パターン5-10回ずつテスト
2. **段階的拡張**: 結果を確認しながら規模拡大
3. **データエクスポート**: CSV形式で結果保存・分析

### 拡張性確保
1. **エンティティ多様化**: Wikidata検索で幅広い対象
2. **属性自動抽出**: 手動設定不要
3. **国際対応**: 英語エンティティも検索可能

## 🔒 **セキュリティ・制限事項**

### セキュリティ
- APIキーはローカルストレージに保存（注意：完全に安全ではない）
- HTTPS通信のみ（API呼び出し）
- CORS制約による一部制限

### 制限事項
- **ブラウザ制限**: 一部古いブラウザでは動作しない可能性
- **ネットワーク依存**: インターネット接続必須
- **API制限**: OpenAI/Wikidataのレート制限に依存

### 推奨環境
- **ブラウザ**: Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
- **ネットワーク**: 安定したインターネット接続
- **JavaScript**: 有効化必須

## 💰 **コスト目安**

### モデル別コスト（1000回実行時）
- **GPT-4o Mini**: 約$0.20-0.60
- **GPT-3.5 Turbo**: 約$2.00-6.00  
- **GPT-4**: 約$30.00-90.00

### 研究用途推奨予算
- **小規模実験（100回）**: $0.02-0.06 (GPT-4o Mini)
- **中規模実験（500回）**: $0.10-0.30 (GPT-4o Mini)
- **大規模実験（2000回）**: $0.40-1.20 (GPT-4o Mini)

## 📈 **データエクスポート機能**

### エクスポート項目
- 実行日時
- エンティティ名・ID
- 属性・プロンプトパターン
- Wikidata回答・LLM回答
- 判定結果・信頼度

### フォーマット
- **CSV形式**: Excel・Googleスプレッドシート対応
- **UTF-8エンコード**: 日本語文字化け防止
- **自動ファイル名**: `fact_check_results_YYYY-MM-DD.csv`

## 🚧 **今後の拡張予定**

### 高優先度
1. **バッチ実行機能**: 複数エンティティの一括処理
2. **結果分析強化**: 統計的有意性検定
3. **多言語対応**: 中国語・韓国語エンティティ
4. **APIキー暗号化**: より安全な保存方式

### 中優先度
1. **カスタム属性**: ユーザー定義属性の追加
2. **プロンプトエディタ**: カスタムパターン作成
3. **履歴管理**: 実行履歴の永続化
4. **チーム機能**: 複数ユーザーでの共有

### 低優先度
1. **クラウド統合**: AWS/GCP連携
2. **機械学習**: 精度予測モデル
3. **リアルタイム同期**: WebSocket通信
4. **モバイルアプリ**: 専用アプリ開発

## 📂 **モジュラー構造 - リファクタリング後**

### JavaScriptモジュール構成

```
js/
├── config.js              # 🎛️ 全設定とコンフィギュレーション
│   ├── DEFAULT_SETTINGS   # システムデフォルト設定
│   ├── API_COSTS          # OpenAI APIコスト情報
│   ├── AVAILABLE_MODELS   # 使用可能なAIモデル一覧
│   ├── ATTRIBUTE_LABELS   # 属性ラベル定義
│   └── PROMPT_PATTERNS    # プロンプトパターン定義
│
├── fact-check-system.js   # 🏗️ 基盤システムクラス
│   ├── 初期化処理         # プロパティ・UIセットアップ
│   ├── イベントハンドラ管理# 安全なイベントリスナー登録
│   └── 基本メソッド群     # 共通機能・ユーティリティ
│
├── wikidata-api.js        # 🔍 Wikidata専用APIモジュール
│   ├── エンティティ検索   # 動的エンティティ・タイプ検索
│   ├── SPARQLクエリ実行   # 動的クエリ生成・実行
│   └── データ処理        # レスポンス正規化・キャッシュ
│
├── openai-api.js          # 🤖 OpenAI専用APIモジュール  
│   ├── API認証・テスト    # キー検証・接続確認
│   ├── チャット補完API    # 全モデル対応（GPT-3.5～5）
│   └── 使用量監視        # コスト計算・制限管理
│
├── main-refactored.js     # 🚀 メインアプリケーション
│   ├── RefactoredFactCheckSystem # 完全機能統合クラス
│   ├── 検索・ファクトチェック実行 # 単体・一括検索処理
│   └── UI更新・結果表示   # 動的UI更新・データ可視化
│
└── main.js                # 📜 レガシー（参照用保持）
```

### 🎯 **モジュール設計の利点**

1. **保守性向上**: 各機能が独立したモジュール
2. **コード再利用**: ES6 import/exportで依存関係明確化
3. **テスト容易性**: 個別モジュールの単体テスト可能
4. **拡張性**: 新機能追加時の影響範囲限定
5. **デバッグ効率**: 問題箇所の特定が容易

## 📚 **技術仕様詳細**

### フロントエンド
- **HTML5/CSS3/JavaScript ES6+**: 基本技術（ES6モジュール対応）
- **Fetch API**: HTTP通信
- **LocalStorage**: 設定・使用量保存
- **Chart.js**: 結果可視化

### API統合
- **OpenAI GPT API**: v1/chat/completions
- **Wikidata API**: Entity Search & Details
- **CORS対応**: origin=* パラメータ使用

### データ構造
```json
{
  "entity": {
    "id": "Q7842",
    "label": "東京大学",
    "description": "日本の国立大学",
    "extractedData": {
      "inception": 1877,
      "location": "東京都",
      "official_website": "https://www.u-tokyo.ac.jp/"
    }
  },
  "result": {
    "wikidata_answer": "1877",
    "llm_answer": "1877年に設立されました。",
    "match_type": "exact",
    "confidence_score": 1.0
  }
}
```

---

**重要**: このシステムは実際のAPI使用料金が発生します。使用前に必ず制限設定を確認し、予算内でご利用ください。

**参考研究**: 高橋萌香. "Wikidataを用いた大規模言語モデルのFact Checkシステムの開発" 大阪電気通信大学, 2024  
**技術基盤**: OpenAI API, Wikidata API, HTML5, CSS3, JavaScript, Chart.js  
**最終更新**: 2024年8月31日